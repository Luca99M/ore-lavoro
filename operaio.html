<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registra Ore Lavoro</title>
    <link rel="manifest" href="/manifest.json">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0f172a, #1e293b);
            color: white;
            min-height: 100vh;
            padding: 15px;
            padding-bottom: 80px;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        .header {
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
        }

        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
        }

        .tab {
            flex: 1;
            padding: 12px;
            background: rgba(30, 41, 59, 0.8);
            border: 2px solid rgba(37, 99, 235, 0.2);
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            font-size: 0.9em;
        }

        .tab.active {
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
            border-color: #3b82f6;
            transform: scale(1.05);
        }

        .card {
            background: rgba(30, 41, 59, 0.95);
            border: 1px solid rgba(37, 99, 235, 0.2);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            color: #94a3b8;
            font-weight: 600;
            margin-bottom: 6px;
            font-size: 0.9em;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            background: rgba(15, 23, 42, 0.9);
            border: 2px solid rgba(37, 99, 235, 0.2);
            color: white;
            padding: 12px;
            border-radius: 8px;
            font-size: 16px;
        }

        .form-textarea {
            resize: vertical;
            min-height: 80px;
        }

        .btn {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 12px;
            font-size: 1.1em;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .activity-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin: 15px 0;
        }

        .activity-btn {
            background: rgba(15, 23, 42, 0.9);
            border: 2px solid rgba(37, 99, 235, 0.3);
            color: white;
            padding: 20px 10px;
            border-radius: 12px;
            font-size: 1.2em;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .activity-btn.selected {
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
            border-color: #3b82f6;
            transform: scale(1.05);
        }

        .pending-list {
            background: rgba(15, 23, 42, 0.6);
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
        }

        .pending-item {
            background: rgba(37, 99, 235, 0.1);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .remove-btn {
            background: #ef4444;
            border: none;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
        }

        .message {
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
            text-align: center;
        }

        .message-success {
            background: rgba(16, 185, 129, 0.1);
            border: 2px solid #10b981;
            color: #6ee7b7;
        }

        .message-error {
            background: rgba(239, 68, 68, 0.1);
            border: 2px solid #ef4444;
            color: #fca5a5;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .absence-item {
            background: rgba(37, 99, 235, 0.1);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
        }

        .absence-item.approved {
            background: rgba(16, 185, 129, 0.1);
            border-left: 4px solid #10b981;
        }

        .absence-item.pending {
            background: rgba(245, 158, 11, 0.1);
            border-left: 4px solid #f59e0b;
        }

        .notification-card {
            background: rgba(59, 130, 246, 0.1);
            border: 2px solid #3b82f6;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
        }

        .notification-card h3 {
            color: #60a5fa;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>‚è±Ô∏è Ore Lavoro</h1>
            <p id="worker-name">Caricamento...</p>
        </div>

        <div id="status-message"></div>

        <!-- TABS -->
        <div class="tabs">
            <div class="tab active" onclick="switchTab('add')">‚ûï Aggiungi</div>
            <div class="tab" onclick="switchTab('history')">üìä Storico</div>
            <div class="tab" onclick="switchTab('absences')">üìÖ Ferie</div>
        </div>

        <!-- TAB: AGGIUNGI ORE -->
        <div id="tab-add" class="tab-content active">
            <div class="card">
                <h2 style="margin-bottom: 15px;">üìù Registra Ore</h2>
                
                <div class="form-group">
                    <label>üìÖ Data</label>
                    <input type="date" id="data" class="form-input">
                </div>

                <div class="form-group">
                    <label>üîß Attivit√†</label>
                    <div id="attivita-grid" class="activity-grid">
                        <div class="activity-btn">Caricamento...</div>
                    </div>
                </div>

                <div class="form-group">
                    <label>‚è±Ô∏è Ore</label>
                    <input type="number" id="ore" class="form-input" step="0.5" min="0" max="24" placeholder="Es: 8">
                </div>

                <div class="form-group">
                    <label>üìù Note (opzionale)</label>
                    <textarea id="note" class="form-textarea" placeholder="Aggiungi dettagli..."></textarea>
                </div>

                <button class="btn btn-primary" onclick="addToList()">‚ûï Aggiungi alla Lista</button>

                <div id="pending-container" style="display: none;">
                    <h3 style="color: #60a5fa; margin: 20px 0 10px;">üìã Da Salvare</h3>
                    <div class="pending-list" id="pending-list"></div>
                    <button class="btn btn-secondary" onclick="saveAllHours()">üíæ SALVA TUTTE LE ORE</button>
                </div>
            </div>
        </div>

        <!-- TAB: STORICO -->
        <div id="tab-history" class="tab-content">
            <div class="card">
                <h2>üìä Le Tue Ore</h2>
                <div class="form-group">
                    <label>Filtra per periodo</label>
                    <select id="history-period" class="form-select" onchange="loadHistory()">
                        <option value="7">Ultimi 7 giorni</option>
                        <option value="30" selected>Ultimi 30 giorni</option>
                        <option value="90">Ultimi 90 giorni</option>
                    </select>
                </div>
                <div id="history-container"></div>
            </div>
        </div>

        <!-- TAB: FERIE/ASSENZE -->
        <div id="tab-absences" class="tab-content">
            <!-- NOTIFICHE -->
            <div class="card">
                <div class="notification-card">
                    <h3>üîî Notifiche Promemoria</h3>
                    <p style="color: #94a3b8; margin-bottom: 10px;">
                        Ricevi un promemoria alle 20:00 se non hai registrato ore
                    </p>
                    <button id="enable-notifications-btn" class="btn btn-secondary" onclick="enableNotifications()">
                        Attiva Notifiche
                    </button>
                </div>
            </div>

            <!-- RICHIEDI ASSENZA -->
            <div class="card">
                <h2>üìÖ Richiedi Assenza</h2>
                
                <div class="form-group">
                    <label>Tipo</label>
                    <select id="absence-type" class="form-select">
                        <option value="ferie">üèñÔ∏è Ferie</option>
                        <option value="malattia">üè• Malattia</option>
                        <option value="permesso">üìù Permesso</option>
                        <option value="altro">‚ùì Altro</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Data Inizio</label>
                    <input type="date" id="absence-start" class="form-input">
                </div>

                <div class="form-group">
                    <label>Data Fine</label>
                    <input type="date" id="absence-end" class="form-input">
                </div>

                <div class="form-group">
                    <label>Motivo (opzionale)</label>
                    <textarea id="absence-reason" class="form-textarea" placeholder="Motivo dell'assenza..."></textarea>
                </div>

                <button class="btn btn-primary" onclick="submitAbsence()">üì§ Invia Richiesta</button>
            </div>

            <!-- LE MIE RICHIESTE -->
            <div class="card">
                <h2>üìã Le Mie Richieste</h2>
                <div id="my-absences-container">
                    <div class="message message-error">Caricamento...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://xxzyhzalfqyqseedsuub.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh4enloemFsZnF5cXNlZWRzdXViIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc2ODgxNjMsImV4cCI6MjA4MzI2NDE2M30.7o18J8g0tcWX2qyrQl-zGBU10AerbHlG-R_WMkjRn7s';

        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let currentWorker = null;
        let selectedActivity = null;
        let pendingList = [];

        // ==========================================
        // INIZIALIZZAZIONE
        // ==========================================
        document.addEventListener('DOMContentLoaded', async function() {
            const urlParams = new URLSearchParams(window.location.search);
            const workerId = urlParams.get('id');

            if (!workerId) {
                alert('ID operaio non fornito!');
                return;
            }

            await loadWorkerInfo(workerId);
            await loadActivities();
            await loadHistory();
            await loadMyAbsences();
            checkNotificationPermission();
            
            // Imposta data odierna
            document.getElementById('data').valueAsDate = new Date();

            // Registra service worker
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(() => console.log('Service Worker registrato'))
                    .catch(err => console.error('Service Worker errore:', err));
            }

            // Controlla ore alle 20:00
            setupDailyCheck();
        });

        // ==========================================
        // WORKER INFO
        // ==========================================
        async function loadWorkerInfo(id) {
            const { data, error } = await supabaseClient
                .from('operai')
                .select('*')
                .eq('id', id)
                .single();

            if (!error && data) {
                currentWorker = data;
                document.getElementById('worker-name').textContent = `${data.nome} ${data.cognome}`;
            }
        }

        // ==========================================
        // ATTIVIT√Ä
        // ==========================================
        async function loadActivities() {
            const { data, error } = await supabaseClient
                .from('attivita')
                .select('*')
                .eq('attiva', true)
                .order('ordine');

            if (!error && data) {
                const grid = document.getElementById('attivita-grid');
                grid.innerHTML = '';

                data.forEach(att => {
                    const btn = document.createElement('div');
                    btn.className = 'activity-btn';
                    btn.textContent = `${att.icona} ${att.nome}`;
                    btn.onclick = () => selectActivity(att.id, btn);
                    btn.dataset.id = att.id;
                    grid.appendChild(btn);
                });
            }
        }

        function selectActivity(id, element) {
            document.querySelectorAll('.activity-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            element.classList.add('selected');
            selectedActivity = id;
        }

        // ==========================================
        // PENDING LIST
        // ==========================================
        function addToList() {
            const data = document.getElementById('data').value;
            const ore = parseFloat(document.getElementById('ore').value);
            const note = document.getElementById('note').value;

            if (!data || !ore || !selectedActivity) {
                showMessage('Compila tutti i campi obbligatori!', 'error');
                return;
            }

            if (ore <= 0 || ore > 24) {
                showMessage('Le ore devono essere tra 0 e 24', 'error');
                return;
            }

            // Trova nome attivit√†
            const actBtn = document.querySelector(`.activity-btn[data-id="${selectedActivity}"]`);
            const actName = actBtn ? actBtn.textContent : 'Attivit√†';

            pendingList.push({
                data,
                attivita_id: selectedActivity,
                attivita_nome: actName,
                ore,
                note
            });

            renderPendingList();
            
            // Reset form
            document.getElementById('ore').value = '';
            document.getElementById('note').value = '';
            document.querySelectorAll('.activity-btn').forEach(btn => btn.classList.remove('selected'));
            selectedActivity = null;

            showMessage('‚úÖ Aggiunto alla lista!', 'success');
        }

        function renderPendingList() {
            const container = document.getElementById('pending-container');
            const list = document.getElementById('pending-list');

            if (pendingList.length === 0) {
                container.style.display = 'none';
                return;
            }

            container.style.display = 'block';
            list.innerHTML = '';

            pendingList.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'pending-item';
                div.innerHTML = `
                    <div>
                        <strong>${item.data}</strong> - ${item.attivita_nome}<br>
                        <span style="color: #10b981; font-weight: bold;">${item.ore}h</span>
                        ${item.note ? `<br><small>${item.note}</small>` : ''}
                    </div>
                    <button class="remove-btn" onclick="removeFromList(${index})">üóëÔ∏è</button>
                `;
                list.appendChild(div);
            });
        }

        function removeFromList(index) {
            pendingList.splice(index, 1);
            renderPendingList();
        }

        async function saveAllHours() {
            if (pendingList.length === 0) {
                showMessage('Nessuna ora da salvare!', 'error');
                return;
            }

            const records = pendingList.map(item => ({
                operaio_id: currentWorker.id,
                data: item.data,
                attivita_id: item.attivita_id,
                ore: item.ore,
                note: item.note || null,
                metodo_inserimento: 'manuale'
            }));

            const { error } = await supabaseClient
                .from('ore_lavorate')
                .insert(records);

            if (error) {
                console.error('Errore:', error);
                showMessage('‚ùå Errore nel salvataggio', 'error');
                return;
            }

            showMessage(`‚úÖ ${pendingList.length} ore salvate con successo!`, 'success');
            pendingList = [];
            renderPendingList();
            loadHistory();
        }

        // ==========================================
        // STORICO
        // ==========================================
        async function loadHistory() {
            const period = parseInt(document.getElementById('history-period').value);
            const startDate = new Date();
            startDate.setDate(startDate.getDate() - period);

            const { data, error } = await supabaseClient
                .from('ore_lavorate')
                .select('*, attivita(nome, icona)')
                .eq('operaio_id', currentWorker.id)
                .gte('data', startDate.toISOString().split('T')[0])
                .order('data', { ascending: false });

            const container = document.getElementById('history-container');

            if (!data || data.length === 0) {
                container.innerHTML = '<div class="message message-error">Nessuna ora registrata</div>';
                return;
            }

            let html = '';
            let currentDate = '';
            let dayTotal = 0;

            data.forEach((item, index) => {
                if (item.data !== currentDate) {
                    if (currentDate) {
                        html += `<div style="text-align: right; padding: 10px; background: rgba(16, 185, 129, 0.1); border-radius: 8px; margin-bottom: 15px;">
                            <strong>Totale: ${dayTotal.toFixed(1)}h</strong>
                        </div>`;
                    }
                    currentDate = item.data;
                    dayTotal = 0;
                    html += `<h3 style="color: #60a5fa; margin: 20px 0 10px;">${item.data}</h3>`;
                }

                dayTotal += parseFloat(item.ore);

                html += `<div class="pending-item">
                    <div>
                        <strong>${item.attivita.icona} ${item.attivita.nome}</strong><br>
                        <span style="color: #10b981; font-weight: bold; font-size: 1.2em;">${item.ore}h</span>
                        ${item.note ? `<br><small style="color: #94a3b8;">${item.note}</small>` : ''}
                    </div>
                </div>`;
            });

            if (currentDate) {
                html += `<div style="text-align: right; padding: 10px; background: rgba(16, 185, 129, 0.1); border-radius: 8px;">
                    <strong>Totale: ${dayTotal.toFixed(1)}h</strong>
                </div>`;
            }

            container.innerHTML = html;
        }

        // ==========================================
        // ASSENZE
        // ==========================================
        async function submitAbsence() {
            const type = document.getElementById('absence-type').value;
            const start = document.getElementById('absence-start').value;
            const end = document.getElementById('absence-end').value;
            const reason = document.getElementById('absence-reason').value;

            if (!start || !end) {
                showMessage('Compila le date!', 'error');
                return;
            }

            if (new Date(start) > new Date(end)) {
                showMessage('La data fine deve essere dopo la data inizio!', 'error');
                return;
            }

            const { error } = await supabaseClient
                .from('assenze')
                .insert({
                    operaio_id: currentWorker.id,
                    tipo: type,
                    data_inizio: start,
                    data_fine: end,
                    motivo: reason || null,
                    approvata: false
                });

            if (error) {
                console.error('Errore:', error);
                showMessage('‚ùå Errore nell\'invio', 'error');
                return;
            }

            showMessage('‚úÖ Richiesta inviata! In attesa di approvazione', 'success');
            
            // Reset form
            document.getElementById('absence-start').value = '';
            document.getElementById('absence-end').value = '';
            document.getElementById('absence-reason').value = '';
            
            loadMyAbsences();
        }

        async function loadMyAbsences() {
            const { data, error } = await supabaseClient
                .from('assenze')
                .select('*')
                .eq('operaio_id', currentWorker.id)
                .order('created_at', { ascending: false });

            const container = document.getElementById('my-absences-container');

            if (!data || data.length === 0) {
                container.innerHTML = '<div class="message message-error">Nessuna richiesta</div>';
                return;
            }

            let html = '';
            data.forEach(abs => {
                const status = abs.approvata ? '‚úÖ Approvata' : '‚è≥ In attesa';
                const className = abs.approvata ? 'approved' : 'pending';
                const icon = abs.tipo === 'ferie' ? 'üèñÔ∏è' : abs.tipo === 'malattia' ? 'üè•' : 'üìù';

                html += `<div class="absence-item ${className}">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong>${icon} ${abs.tipo.toUpperCase()}</strong><br>
                            Dal ${abs.data_inizio} al ${abs.data_fine}
                            ${abs.motivo ? `<br><small style="color: #94a3b8;">${abs.motivo}</small>` : ''}
                        </div>
                        <div style="text-align: right;">
                            <strong>${status}</strong>
                        </div>
                    </div>
                </div>`;
            });

            container.innerHTML = html;
        }

        // ==========================================
        // NOTIFICHE
        // ==========================================
        function checkNotificationPermission() {
            if (!('Notification' in window)) {
                document.getElementById('enable-notifications-btn').style.display = 'none';
                return;
            }

            if (Notification.permission === 'granted') {
                document.getElementById('enable-notifications-btn').textContent = '‚úÖ Notifiche Attive';
                document.getElementById('enable-notifications-btn').disabled = true;
            }
        }

        async function enableNotifications() {
            if (!('Notification' in window)) {
                showMessage('Il tuo browser non supporta le notifiche', 'error');
                return;
            }

            const permission = await Notification.requestPermission();
            
            if (permission === 'granted') {
                showMessage('‚úÖ Notifiche attivate!', 'success');
                document.getElementById('enable-notifications-btn').textContent = '‚úÖ Notifiche Attive';
                document.getElementById('enable-notifications-btn').disabled = true;
                
                // Test notifica
                new Notification('üîî Notifiche Attivate!', {
                    body: 'Riceverai promemoria alle 20:00 se non hai registrato ore',
                    icon: '/icon-192.png'
                });
            }
        }

        function setupDailyCheck() {
            // Controlla ogni ora se sono le 20:00
            setInterval(async () => {
                const now = new Date();
                if (now.getHours() === 20 && now.getMinutes() < 5) {
                    await checkAndNotify();
                }
            }, 5 * 60 * 1000); // Ogni 5 minuti
        }

        async function checkAndNotify() {
            const today = new Date().toISOString().split('T')[0];
            
            const { data } = await supabaseClient
                .from('ore_lavorate')
                .select('id')
                .eq('operaio_id', currentWorker.id)
                .eq('data', today);

            if (!data || data.length === 0) {
                if (Notification.permission === 'granted') {
                    new Notification('‚è±Ô∏è Ricorda di segnare le ore!', {
                        body: 'Non hai ancora registrato le ore di oggi',
                        icon: '/icon-192.png',
                        requireInteraction: true
                    });
                }
            }
        }

        // ==========================================
        // TABS
        // ==========================================
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));

            event.target.classList.add('active');
            document.getElementById(`tab-${tabName}`).classList.add('active');

            if (tabName === 'history') {
                loadHistory();
            } else if (tabName === 'absences') {
                loadMyAbsences();
            }
        }

        // ==========================================
        // UTILITY
        // ==========================================
        function showMessage(message, type) {
            const container = document.getElementById('status-message');
            container.innerHTML = `<div class="message message-${type}">${message}</div>`;
            setTimeout(() => container.innerHTML = '', 3000);
        }
    </script>
</body>
</html>
