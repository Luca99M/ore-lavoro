<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestionale Ore Lavoro - Admin</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0f172a, #1e293b);
            color: white;
            min-height: 100vh;
            padding: 20px;
            padding-bottom: 100px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
        }

        .header h1 {
            font-size: 2em;
            margin-bottom: 8px;
        }

        .header .subtitle {
            font-size: 1em;
            opacity: 0.9;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(30, 41, 59, 0.95);
            border: 1px solid rgba(37, 99, 235, 0.2);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(37, 99, 235, 0.3);
        }

        .stat-value {
            font-size: 2.5em;
            font-weight: bold;
            background: linear-gradient(135deg, #3b82f6, #10b981);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9em;
            color: #94a3b8;
        }

        .card {
            background: rgba(30, 41, 59, 0.95);
            border: 1px solid rgba(37, 99, 235, 0.2);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
        }

        .card h2 {
            color: #60a5fa;
            margin-bottom: 20px;
            font-size: 1.4em;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }

        .btn:hover {
            transform: scale(1.05);
        }

        .btn:active {
            transform: scale(0.98);
        }

        .operaio-item {
            background: rgba(15, 23, 42, 0.6);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 4px solid #3b82f6;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .operaio-info {
            flex: 1;
            min-width: 200px;
        }

        .operaio-name {
            font-size: 1.3em;
            font-weight: bold;
            color: #60a5fa;
            margin-bottom: 5px;
        }

        .operaio-stats {
            color: #94a3b8;
            font-size: 0.9em;
        }

        .operaio-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .attivita-item {
            background: rgba(15, 23, 42, 0.6);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 4px solid #10b981;
        }

        .attivita-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .attivita-name {
            font-size: 1.2em;
            font-weight: bold;
            color: #10b981;
        }

        .keywords-container {
            background: rgba(15, 23, 42, 0.8);
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
        }

        .keywords-label {
            color: #94a3b8;
            font-size: 0.9em;
            margin-bottom: 8px;
        }

        .keyword-tag {
            display: inline-block;
            background: rgba(59, 130, 246, 0.2);
            border: 1px solid #3b82f6;
            padding: 5px 10px;
            border-radius: 5px;
            margin: 3px;
            font-size: 0.85em;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: linear-gradient(135deg, #1e293b, #0f172a);
            border: 2px solid rgba(37, 99, 235, 0.3);
            border-radius: 15px;
            padding: 30px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 50px rgba(0, 0, 0, 0.5);
        }

        .modal-header {
            font-size: 1.5em;
            color: #60a5fa;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            color: #94a3b8;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            background: rgba(15, 23, 42, 0.9);
            border: 2px solid rgba(37, 99, 235, 0.2);
            color: white;
            padding: 12px;
            border-radius: 8px;
            font-size: 16px;
        }

        .form-textarea {
            min-height: 120px;
            resize: vertical;
            font-family: inherit;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 8px rgba(37, 99, 235, 0.3);
        }

        .link-display {
            background: rgba(16, 185, 129, 0.1);
            border: 2px solid #10b981;
            padding: 15px;
            border-radius: 8px;
            word-break: break-all;
            color: #6ee7b7;
            font-family: 'Courier New', monospace;
            margin: 15px 0;
        }

        .message {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            text-align: center;
        }

        .message-success {
            background: rgba(16, 185, 129, 0.1);
            border: 2px solid #10b981;
            color: #6ee7b7;
        }

        .message-error {
            background: rgba(239, 68, 68, 0.1);
            border: 2px solid #ef4444;
            color: #fca5a5;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .tab {
            padding: 12px 24px;
            background: rgba(30, 41, 59, 0.8);
            border: 2px solid rgba(37, 99, 235, 0.2);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .tab.active {
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
            border-color: #3b82f6;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .chart-container {
            height: 300px;
            position: relative;
            margin-top: 20px;
        }

        @media (max-width: 768px) {
            .operaio-item {
                flex-direction: column;
                align-items: flex-start;
            }

            .operaio-actions {
                width: 100%;
            }

            .btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- HEADER -->
        <div class="header">
            <h1> Gestionale Ore Lavoro</h1>
            <div class="subtitle">Pannello Amministratore</div>
        </div>

        <!-- STATISTICHE GENERALI -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="stat-today-hours">0h</div>
                <div class="stat-label">Ore Oggi</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="stat-week-hours">0h</div>
                <div class="stat-label">Ore Settimana</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="stat-active-workers">0</div>
                <div class="stat-label">Operai Attivi</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="stat-activities">0</div>
                <div class="stat-label">Attivit</div>
            </div>
        </div>

        <!-- TABS -->
        <div class="tabs">
            <div class="tab active" onclick="switchTab('operai')"> Operai</div>
            <div class="tab" onclick="switchTab('attivita')"> Attivit</div>
            <div class="tab" onclick="switchTab('report')"> Report</div>
        </div>

        <!-- TAB: OPERAI -->
        <div id="tab-operai" class="tab-content active">
            <div class="card">
                <h2> Gestione Operai</h2>
                <button class="btn btn-primary" onclick="openNewOperaioModal()"> Nuovo Operaio</button>
                <div id="operai-list" style="margin-top: 25px;">
                    <div style="text-align: center; color: #94a3b8; padding: 20px;">Caricamento operai...</div>
                </div>
            </div>
        </div>

        <!-- TAB: ATTIVIT -->
        <div id="tab-attivita" class="tab-content">
            <div class="card">
                <h2> Gestione Attivit</h2>
                <button class="btn btn-primary" onclick="openNewAttivitaModal()"> Nuova Attivit</button>
                <div id="attivita-list" style="margin-top: 25px;">
                    <div style="text-align: center; color: #94a3b8; padding: 20px;">Caricamento attivit...</div>
                </div>
            </div>
        </div>

        <!-- TAB: REPORT -->
        <div id="tab-report" class="tab-content">
            <div class="card">
                <h2> Report Ore per Operaio</h2>
                <div class="form-group">
                    <label>Periodo</label>
                    <select id="report-period" class="form-select" onchange="loadReport()">
                        <option value="7">Ultimi 7 giorni</option>
                        <option value="30" selected>Ultimo mese</option>
                        <option value="90">Ultimi 3 mesi</option>
                    </select>
                </div>
                <div class="chart-container">
                    <canvas id="report-chart"></canvas>
                </div>
            </div>

            <div class="card">
                <h2> Report Ore per Attivit</h2>
                <div class="chart-container">
                    <canvas id="activity-chart"></canvas>
                </div>
            </div>

            <!-- EXPORT EXCEL -->
            <div class="card">
                <h2> Export Dati</h2>
                <p style="color: #94a3b8; margin-bottom: 15px;">Esporta tutti i dati in formato Excel (compatibile con il tuo foglio presenze)</p>
                <button class="btn btn-primary" onclick="exportToExcel()" style="width: 100%;"> EXPORT EXCEL</button>
            </div>
        </div>

        <div id="status-message"></div>
    </div>

    <!-- MODAL: NUOVO OPERAIO -->
    <div id="modal-new-operaio" class="modal">
        <div class="modal-content">
            <div class="modal-header"> Crea Nuovo Operaio</div>
            
            <div class="form-group">
                <label>Nome *</label>
                <input type="text" id="new-operaio-nome" class="form-input" placeholder="Mario">
            </div>

            <div class="form-group">
                <label>Cognome *</label>
                <input type="text" id="new-operaio-cognome" class="form-input" placeholder="Rossi">
            </div>

            <button class="btn btn-primary" onclick="createOperaio()" style="width: 100%; margin-bottom: 10px;"> Crea Operaio</button>
            <button class="btn btn-secondary" onclick="closeModal('modal-new-operaio')" style="width: 100%;"> Annulla</button>
        </div>
    </div>

    <!-- MODAL: MOSTRA LINK -->
    <div id="modal-show-link" class="modal">
        <div class="modal-content">
            <div class="modal-header"> Link Personale Operaio</div>
            
            <div id="link-content"></div>

            <button class="btn btn-secondary" onclick="closeModal('modal-show-link')" style="width: 100%; margin-top: 15px;">Chiudi</button>
        </div>
    </div>

    <!-- MODAL: NUOVA ATTIVIT -->
    <div id="modal-new-attivita" class="modal">
        <div class="modal-content">
            <div class="modal-header" id="attivita-modal-title"> Nuova Attivit</div>
            
            <input type="hidden" id="edit-attivita-id">

            <div class="form-group">
                <label>Nome Attivit *</label>
                <input type="text" id="new-attivita-nome" class="form-input" placeholder="Es: Taglio legna">
            </div>

            <div class="form-group">
                <label>Icona (emoji)</label>
                <input type="text" id="new-attivita-icona" class="form-input" placeholder="" maxlength="5">
            </div>

            <div class="form-group">
                <label>Keywords (parole chiave per riconoscimento vocale)</label>
                <textarea id="new-attivita-keywords" class="form-textarea" placeholder="Inserisci le parole separate da virgola.&#10;Es: legna, bosco, motosega, tagliare, taglio"></textarea>
                <div style="color: #94a3b8; font-size: 0.85em; margin-top: 8px;">
                     Quando l'operaio dice una di queste parole, il sistema associa automaticamente questa attivit
                </div>
            </div>

            <div class="form-group">
                <label>Colore</label>
                <input type="color" id="new-attivita-colore" class="form-input" value="#3b82f6">
            </div>

            <button class="btn btn-primary" onclick="saveAttivita()" style="width: 100%; margin-bottom: 10px;"> Salva</button>
            <button class="btn btn-secondary" onclick="closeModal('modal-new-attivita')" style="width: 100%;"> Annulla</button>
        </div>
    </div>

    <script>
        // ==========================================
        // CONFIGURAZIONE SUPABASE
        // ==========================================
        const SUPABASE_URL = 'https://xxzyhzalfqyqseedsuub.supabase.co';
        const SUPABASE_ANON_KEY =  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh4enloemFsZnF5cXNlZWRzdXViIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2NzY4ODE2MywiZXhwIjoyMDgzMjY0MTYzfQ.Y1fUlGwzlzjYc-zJnOIF7X-7V7FrcRzfJJN5ZNhgi2s';

        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // ==========================================
        // VARIABILI GLOBALI
        // ==========================================
        let operai = [];
        let attivita = [];
        let reportChart = null;
        let activityChart = null;

        // ==========================================
        // INIZIALIZZAZIONE
        // ==========================================
        document.addEventListener('DOMContentLoaded', async function() {
            await loadStats();
            await loadOperai();
            await loadAttivita();
        });

        // ==========================================
        // CARICA STATISTICHE
        // ==========================================
        async function loadStats() {
            try {
                const today = new Date().toISOString().split('T')[0];
                const weekAgo = new Date();
                weekAgo.setDate(weekAgo.getDate() - 7);
                const weekAgoStr = weekAgo.toISOString().split('T')[0];

                // Ore oggi
                const { data: todayData } = await supabaseClient
                    .from('ore_lavorate')
                    .select('ore')
                    .eq('data', today);

                const todayHours = todayData ? todayData.reduce((sum, item) => sum + parseFloat(item.ore), 0) : 0;
                document.getElementById('stat-today-hours').textContent = `${Math.round(todayHours)}h`;

                // Ore settimana
                const { data: weekData } = await supabaseClient
                    .from('ore_lavorate')
                    .select('ore')
                    .gte('data', weekAgoStr);

                const weekHours = weekData ? weekData.reduce((sum, item) => sum + parseFloat(item.ore), 0) : 0;
                document.getElementById('stat-week-hours').textContent = `${Math.round(weekHours)}h`;

                // Operai attivi
                const { data: operaiData } = await supabaseClient
                    .from('operai')
                    .select('*')
                    .eq('attivo', true);

                document.getElementById('stat-active-workers').textContent = operaiData ? operaiData.length : 0;

                // Attivit
                const { data: attivitaData } = await supabaseClient
                    .from('attivita')
                    .select('*')
                    .eq('attiva', true);

                document.getElementById('stat-activities').textContent = attivitaData ? attivitaData.length : 0;

            } catch (error) {
                console.error('Errore caricamento statistiche:', error);
            }
        }

        // ==========================================
        // CARICA OPERAI
        // ==========================================
        async function loadOperai() {
            try {
                const { data, error } = await supabaseClient
                    .from('operai')
                    .select('*')
                    .order('cognome', { ascending: true });

                if (error) throw error;

                operai = data || [];

                if (operai.length === 0) {
                    document.getElementById('operai-list').innerHTML = 
                        '<div style="text-align: center; color: #94a3b8; padding: 20px;">Nessun operaio registrato</div>';
                    return;
                }

                // Per ogni operaio, carica le ore di oggi
                const today = new Date().toISOString().split('T')[0];
                const operaiWithHours = await Promise.all(
                    operai.map(async (op) => {
                        const { data: todayHours } = await supabaseClient
                            .from('ore_lavorate')
                            .select('ore')
                            .eq('operaio_id', op.id)
                            .eq('data', today);

                        const hours = todayHours ? todayHours.reduce((sum, item) => sum + parseFloat(item.ore), 0) : 0;
                        return { ...op, todayHours: hours };
                    })
                );

                const html = operaiWithHours.map(op => `
                    <div class="operaio-item" style="border-left-color: ${op.attivo ? '#10b981' : '#ef4444'}">
                        <div class="operaio-info">
                            <div class="operaio-name">${op.nome} ${op.cognome}</div>
                            <div class="operaio-stats">
                                Oggi: <strong>${op.todayHours}h</strong>  
                                ${op.attivo ? ' Attivo' : ' Non attivo'}
                            </div>
                        </div>
                        <div class="operaio-actions">
                            <button class="btn btn-secondary" onclick="showLink('${op.token_personale}', '${op.nome} ${op.cognome}')">
                                 Vedi Link
                            </button>
                            <button class="btn btn-primary" onclick="openOperaioLink('${op.token_personale}')">
                                 Gestisci Ore
                            </button>
                            <button class="btn ${op.attivo ? 'btn-danger' : 'btn-primary'}" onclick="toggleOperaioStatus('${op.id}', ${!op.attivo})">
                                ${op.attivo ? ' Disattiva' : ' Attiva'}
                            </button>
                        </div>
                    </div>
                `).join('');

                document.getElementById('operai-list').innerHTML = html;

            } catch (error) {
                console.error('Errore caricamento operai:', error);
                showMessage(' Errore caricamento operai', 'error');
            }
        }

        // ==========================================
        // CREA OPERAIO
        // ==========================================
        function openNewOperaioModal() {
            document.getElementById('new-operaio-nome').value = '';
            document.getElementById('new-operaio-cognome').value = '';
            openModal('modal-new-operaio');
        }

        async function createOperaio() {
            const nome = document.getElementById('new-operaio-nome').value.trim();
            const cognome = document.getElementById('new-operaio-cognome').value.trim();

            if (!nome || !cognome) {
                showMessage(' Inserisci nome e cognome', 'error');
                return;
            }

            try {
                const { data, error } = await supabaseClient
                    .from('operai')
                    .insert({ nome, cognome })
                    .select()
                    .single();

                if (error) throw error;

                closeModal('modal-new-operaio');
                showMessage(` Operaio ${nome} ${cognome} creato!`, 'success');
                
                // Mostra subito il link
                showLink(data.token_personale, `${nome} ${cognome}`);
                
                await loadOperai();
                await loadStats();

            } catch (error) {
                console.error('Errore creazione operaio:', error);
                showMessage(' Errore nella creazione', 'error');
            }
        }

        // ==========================================
        // MOSTRA LINK
        // ==========================================
        function showLink(token, nomeCompleto) {
            const baseUrl = window.location.origin + window.location.pathname.replace('gestionale.html', '');
            const fullLink = `${baseUrl}operaio.html?token=${token}`;

            document.getElementById('link-content').innerHTML = `
                <p style="margin-bottom: 15px; color: #94a3b8;">
                    Link personale per <strong style="color: #60a5fa;">${nomeCompleto}</strong>:
                </p>
                <div class="link-display">${fullLink}</div>
                <button class="btn btn-primary" onclick="copyToClipboard('${fullLink}')" style="width: 100%; margin-bottom: 10px;">
                     Copia Link
                </button>
                <button class="btn btn-secondary" onclick="window.open('${fullLink}', '_blank')" style="width: 100%;">
                     Apri Link
                </button>
                <div style="margin-top: 15px; padding: 12px; background: rgba(59, 130, 246, 0.1); border-radius: 8px; font-size: 0.9em; color: #94a3b8;">
                     Invia questo link all'operaio tramite WhatsApp, Email o SMS. L'operaio deve salvarlo nei preferiti del browser per accesso rapido.
                </div>
            `;

            openModal('modal-show-link');
        }

        function openOperaioLink(token) {
            const baseUrl = window.location.origin + window.location.pathname.replace('gestionale.html', '');
            const fullLink = `${baseUrl}operaio.html?token=${token}`;
            window.open(fullLink, '_blank');
        }

        // ==========================================
        // TOGGLE OPERAIO STATUS
        // ==========================================
        async function toggleOperaioStatus(id, newStatus) {
            try {
                const { error } = await supabaseClient
                    .from('operai')
                    .update({ attivo: newStatus })
                    .eq('id', id);

                if (error) throw error;

                showMessage(` Operaio ${newStatus ? 'attivato' : 'disattivato'}`, 'success');
                await loadOperai();
                await loadStats();

            } catch (error) {
                console.error('Errore aggiornamento stato:', error);
                showMessage(' Errore aggiornamento', 'error');
            }
        }

        // ==========================================
        // CARICA ATTIVIT
        // ==========================================
        async function loadAttivita() {
            try {
                const { data, error } = await supabaseClient
                    .from('attivita')
                    .select('*')
                    .order('ordine', { ascending: true });

                if (error) throw error;

                attivita = data || [];

                if (attivita.length === 0) {
                    document.getElementById('attivita-list').innerHTML = 
                        '<div style="text-align: center; color: #94a3b8; padding: 20px;">Nessuna attivit</div>';
                    return;
                }

                const html = attivita.map(att => `
                    <div class="attivita-item" style="border-left-color: ${att.colore}">
                        <div class="attivita-header">
                            <div class="attivita-name">${att.icona} ${att.nome}</div>
                            <div style="display: flex; gap: 10px;">
                                <button class="btn btn-secondary" onclick="editAttivita('${att.id}')"> Modifica</button>
                                <button class="btn ${att.attiva ? 'btn-danger' : 'btn-primary'}" onclick="toggleAttivitaStatus('${att.id}', ${!att.attiva})">
                                    ${att.attiva ? ' Disattiva' : ' Attiva'}
                                </button>
                            </div>
                        </div>
                        <div class="keywords-container">
                            <div class="keywords-label"> Keywords per riconoscimento vocale:</div>
                            <div>
                                ${att.keywords && att.keywords.length > 0 
                                    ? att.keywords.map(kw => `<span class="keyword-tag">${kw}</span>`).join('') 
                                    : '<span style="color: #94a3b8;">Nessuna keyword</span>'}
                            </div>
                        </div>
                    </div>
                `).join('');

                document.getElementById('attivita-list').innerHTML = html;

            } catch (error) {
                console.error('Errore caricamento attivit:', error);
                showMessage(' Errore caricamento attivit', 'error');
            }
        }

        // ==========================================
        // NUOVA/MODIFICA ATTIVIT
        // ==========================================
        function openNewAttivitaModal() {
            document.getElementById('attivita-modal-title').textContent = ' Nuova Attivit';
            document.getElementById('edit-attivita-id').value = '';
            document.getElementById('new-attivita-nome').value = '';
            document.getElementById('new-attivita-icona').value = '';
            document.getElementById('new-attivita-keywords').value = '';
            document.getElementById('new-attivita-colore').value = '#3b82f6';
            openModal('modal-new-attivita');
        }

        function editAttivita(id) {
            const att = attivita.find(a => a.id === id);
            if (!att) return;

            document.getElementById('attivita-modal-title').textContent = ' Modifica Attivit';
            document.getElementById('edit-attivita-id').value = id;
            document.getElementById('new-attivita-nome').value = att.nome;
            document.getElementById('new-attivita-icona').value = att.icona;
            document.getElementById('new-attivita-keywords').value = att.keywords ? att.keywords.join(', ') : '';
            document.getElementById('new-attivita-colore').value = att.colore;
            openModal('modal-new-attivita');
        }

        async function saveAttivita() {
            const id = document.getElementById('edit-attivita-id').value;
            const nome = document.getElementById('new-attivita-nome').value.trim();
            const icona = document.getElementById('new-attivita-icona').value.trim();
            const keywordsStr = document.getElementById('new-attivita-keywords').value.trim();
            const colore = document.getElementById('new-attivita-colore').value;

            if (!nome) {
                showMessage(' Inserisci il nome dell\'attivit', 'error');
                return;
            }

            // Parse keywords
            const keywords = keywordsStr
                .split(',')
                .map(k => k.trim().toLowerCase())
                .filter(k => k.length > 0);

            try {
                const dataToSave = {
                    nome,
                    icona: icona || '',
                    keywords,
                    colore
                };

                if (id) {
                    // Update
                    const { error } = await supabaseClient
                        .from('attivita')
                        .update(dataToSave)
                        .eq('id', id);

                    if (error) throw error;
                    showMessage(' Attivit aggiornata!', 'success');
                } else {
                    // Insert
                    const { error } = await supabaseClient
                        .from('attivita')
                        .insert(dataToSave);

                    if (error) throw error;
                    showMessage(' Attivit creata!', 'success');
                }

                closeModal('modal-new-attivita');
                await loadAttivita();
                await loadStats();

            } catch (error) {
                console.error('Errore salvataggio attivit:', error);
                showMessage(' Errore nel salvataggio', 'error');
            }
        }

        async function toggleAttivitaStatus(id, newStatus) {
            try {
                const { error } = await supabaseClient
                    .from('attivita')
                    .update({ attiva: newStatus })
                    .eq('id', id);

                if (error) throw error;

                showMessage(` Attivit ${newStatus ? 'attivata' : 'disattivata'}`, 'success');
                await loadAttivita();
                await loadStats();

            } catch (error) {
                console.error('Errore aggiornamento stato:', error);
                showMessage(' Errore aggiornamento', 'error');
            }
        }

        // ==========================================
        // REPORT
        // ==========================================
        async function loadReport() {
            const days = parseInt(document.getElementById('report-period').value);
            const startDate = new Date();
            startDate.setDate(startDate.getDate() - days);

            try {
                // Report per operaio
                const { data: oreData } = await supabaseClient
                    .from('ore_lavorate')
                    .select('*, operai(*)')
                    .gte('data', startDate.toISOString().split('T')[0]);

                if (!oreData || oreData.length === 0) {
                    return;
                }

                // Raggruppa per operaio
                const operaioHours = {};
                oreData.forEach(item => {
                    const name = `${item.operai.nome} ${item.operai.cognome}`;
                    if (!operaioHours[name]) {
                        operaioHours[name] = 0;
                    }
                    operaioHours[name] += parseFloat(item.ore);
                });

                // Grafico operai
                const ctx1 = document.getElementById('report-chart');
                if (reportChart) reportChart.destroy();

                reportChart = new Chart(ctx1, {
                    type: 'bar',
                    data: {
                        labels: Object.keys(operaioHours),
                        datasets: [{
                            label: 'Ore Lavorate',
                            data: Object.values(operaioHours).map(h => Math.round(h)),
                            backgroundColor: '#10b981',
                            borderWidth: 2,
                            borderColor: '#1e293b'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            y: {
                                ticks: { color: '#94a3b8' },
                                grid: { color: 'rgba(148, 163, 184, 0.1)' }
                            },
                            x: {
                                ticks: { color: '#94a3b8' },
                                grid: { color: 'rgba(148, 163, 184, 0.1)' }
                            }
                        }
                    }
                });

                // Report per attivit
                const { data: oreAttData } = await supabaseClient
                    .from('ore_lavorate')
                    .select('*, attivita(*)')
                    .gte('data', startDate.toISOString().split('T')[0]);

                const activityHours = {};
                oreAttData.forEach(item => {
                    const name = item.attivita.nome;
                    if (!activityHours[name]) {
                        activityHours[name] = 0;
                    }
                    activityHours[name] += parseFloat(item.ore);
                });

                // Grafico attivit
                const ctx2 = document.getElementById('activity-chart');
                if (activityChart) activityChart.destroy();

                activityChart = new Chart(ctx2, {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(activityHours),
                        datasets: [{
                            data: Object.values(activityHours).map(h => Math.round(h)),
                            backgroundColor: [
                                '#10b981', '#3b82f6', '#f59e0b', '#ef4444',
                                '#8b5cf6', '#ec4899', '#06b6d4', '#84cc16'
                            ],
                            borderWidth: 2,
                            borderColor: '#1e293b'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: { color: '#94a3b8' }
                            }
                        }
                    }
                });

            } catch (error) {
                console.error('Errore caricamento report:', error);
            }
        }

        // ==========================================
        // TABS
        // ==========================================
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));

            event.target.classList.add('active');
            document.getElementById(`tab-${tabName}`).classList.add('active');

            if (tabName === 'report') {
                loadReport();
            }
        }

        // ==========================================
        // MODALS
        // ==========================================
        function openModal(id) {
            document.getElementById(id).classList.add('active');
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('active');
        }

        // ==========================================
        // UTILITY
        // ==========================================
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showMessage(' Link copiato negli appunti!', 'success');
            }).catch(() => {
                showMessage(' Errore copia link', 'error');
            });
        }

        function showMessage(message, type) {
            const container = document.getElementById('status-message');
            container.innerHTML = `<div class="message message-${type}">${message}</div>`;
            setTimeout(() => container.innerHTML = '', 4000);
        }


        // ==========================================
        // EXPORT TO EXCEL
        // ==========================================
        async function exportToExcel() {
            try {
                showMessage(' Generando Excel...', 'info');
                
                // Preleva tutti i dati
                const { data: oreData } = await supabaseClient
                    .from('ore_lavorate')
                    .select('*, operai(*), attivita(*)')
                    .order('data', { ascending: true });

                if (!oreData || oreData.length === 0) {
                    showMessage(' Nessun dato da esportare', 'error');
                    return;
                }

                // Raggruppa per mese/anno
                const dataByMonth = {};
                oreData.forEach(item => {
                    const date = new Date(item.data);
                    const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                    if (!dataByMonth[monthKey]) {
                        dataByMonth[monthKey] = [];
                    }
                    dataByMonth[monthKey].push(item);
                });

                // Crea workbook
                const wb = XLSX.utils.book_new();

                // Per ogni mese, crea un foglio
                Object.entries(dataByMonth).forEach(([monthKey, monthData]) => {
                    const [year, month] = monthKey.split('-');
                    const monthNames = ['Gen', 'Feb', 'Mar', 'Apr', 'Mag', 'Giu', 'Lug', 'Ago', 'Set', 'Ott', 'Nov', 'Dic'];
                    const sheetName = `${monthNames[parseInt(month) - 1]} ${year}`;

                    // Struttura Excel: operaio | 1 | 2 | 3 | ... | 31 | TOTALE
                    const daysInMonth = new Date(parseInt(year), parseInt(month), 0).getDate();
                    
                    // Header
                    const headerRow = ['Nome'];
                    for (let d = 1; d <= daysInMonth; d++) {
                        headerRow.push(d);
                    }
                    headerRow.push('TOTALE');

                    // Dati operai
                    const operaiData = {};
                    monthData.forEach(item => {
                        const operaioName = `${item.operai.nome} ${item.operai.cognome}`.trim();
                        const day = new Date(item.data).getDate();
                        
                        if (!operaiData[operaioName]) {
                            operaiData[operaioName] = Array(daysInMonth + 2).fill('');
                            operaiData[operaioName][0] = operaioName;
                        }
                        
                        // Aggiungi ore al giorno
                        const currentValue = operaiData[operaioName][day] || 0;
                        operaiData[operaioName][day] = (parseFloat(currentValue) + parseFloat(item.ore)).toFixed(1);
                    });

                    // Calcola totali
                    Object.keys(operaiData).forEach(name => {
                        let total = 0;
                        for (let d = 1; d <= daysInMonth; d++) {
                            const val = operaiData[name][d];
                            if (val && val !== '') {
                                total += parseFloat(val);
                            }
                        }
                        operaiData[name][daysInMonth + 1] = total.toFixed(1);
                    });

                    // Converti in array per Excel
                    const sheetData = [headerRow];
                    Object.values(operaiData).forEach(row => {
                        sheetData.push(row);
                    });

                    // Crea foglio
                    const ws = XLSX.utils.aoa_to_sheet(sheetData);
                    
                    // Aggiungi al workbook
                    XLSX.utils.book_append_sheet(wb, ws, sheetName);
                });

                // Scarica file
                const today = new Date().toISOString().split('T')[0];
                XLSX.writeFile(wb, `presenze_${today}.xlsx`);
                
                showMessage(' Excel scaricato con successo!', 'success');

            } catch (error) {
                console.error('Errore export Excel:', error);
                showMessage(' Errore durante l\'export', 'error');
            }
        }

        // Click fuori modal per chiudere
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.classList.remove('active');
            }
        }
    </script>
</body>
</html>
