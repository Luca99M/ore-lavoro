<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestionale Ore Lavoro - SUPER</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0f172a, #1e293b);
            color: white;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
        }

        .header h1 {
            font-size: 1.8em;
            margin-bottom: 5px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .tab {
            flex: 1;
            min-width: 150px;
            padding: 12px;
            background: rgba(30, 41, 59, 0.8);
            border: 2px solid rgba(37, 99, 235, 0.2);
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .tab.active {
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
            border-color: #3b82f6;
        }

        .tab:hover {
            transform: scale(1.02);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .card {
            background: rgba(30, 41, 59, 0.95);
            border: 1px solid rgba(37, 99, 235, 0.2);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .card h2 {
            color: #60a5fa;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            color: #94a3b8;
            font-weight: 600;
            margin-bottom: 6px;
            font-size: 0.9em;
        }

        .form-input, .form-select {
            width: 100%;
            background: rgba(15, 23, 42, 0.9);
            border: 2px solid rgba(37, 99, 235, 0.2);
            color: white;
            padding: 12px;
            border-radius: 8px;
            font-size: 16px;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 8px rgba(37, 99, 235, 0.3);
        }

        .btn {
            padding: 14px 20px;
            border: none;
            border-radius: 10px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
        }

        .btn:hover {
            transform: scale(1.02);
        }

        .chart-container {
            position: relative;
            height: 400px;
            margin: 20px 0;
            background: rgba(15, 23, 42, 0.6);
            padding: 20px;
            border-radius: 10px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .stat-card {
            background: rgba(15, 23, 42, 0.6);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #10b981;
        }

        .stat-label {
            color: #94a3b8;
            margin-top: 5px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid rgba(148, 163, 184, 0.1);
        }

        th {
            background: rgba(37, 99, 235, 0.1);
            color: #60a5fa;
            font-weight: 600;
        }

        tr:hover {
            background: rgba(37, 99, 235, 0.05);
        }

        .message {
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
            text-align: center;
        }

        .message-success {
            background: rgba(16, 185, 129, 0.1);
            border: 2px solid #10b981;
            color: #6ee7b7;
        }

        .message-error {
            background: rgba(239, 68, 68, 0.1);
            border: 2px solid #ef4444;
            color: #fca5a5;
        }

        .message-info {
            background: rgba(59, 130, 246, 0.1);
            border: 2px solid #3b82f6;
            color: #93c5fd;
        }

        .absent-item {
            padding: 15px;
            background: rgba(239, 68, 68, 0.1);
            border-left: 4px solid #ef4444;
            margin-bottom: 10px;
            border-radius: 8px;
        }

        .absent-item.justified {
            background: rgba(16, 185, 129, 0.1);
            border-left-color: #10b981;
        }

        .request-item {
            padding: 15px;
            background: rgba(59, 130, 246, 0.1);
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        @media (max-width: 768px) {
            .tabs {
                flex-direction: column;
            }
            
            .tab {
                min-width: 100%;
            }

            .chart-container {
                height: 300px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Gestionale Ore Lavoro SUPER</h1>
            <p>Dashboard amministrativa con analisi avanzate</p>
        </div>

        <div id="status-message"></div>

        <!-- TABS -->
        <div class="tabs">
            <div class="tab active" onclick="switchTab('dashboard')">üè† Dashboard</div>
            <div class="tab" onclick="switchTab('person-analysis')">üìä Analisi Persona</div>
            <div class="tab" onclick="switchTab('activity-analysis')">üîß Analisi Attivit√†</div>
            <div class="tab" onclick="switchTab('absences')">üìÖ Assenze</div>
            <div class="tab" onclick="switchTab('workers')">üë∑ Operai</div>
            <div class="tab" onclick="switchTab('activities')">‚öôÔ∏è Attivit√†</div>
        </div>

        <!-- TAB: DASHBOARD -->
        <div id="tab-dashboard" class="tab-content active">
            <div class="card">
                <h2>üìà Statistiche Generali</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="stat-total-hours">0</div>
                        <div class="stat-label">Ore Totali (Mese)</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="stat-active-workers">0</div>
                        <div class="stat-label">Operai Attivi</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="stat-activities">0</div>
                        <div class="stat-label">Attivit√† Totali</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="stat-today">0h</div>
                        <div class="stat-label">Ore Oggi</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB: ANALISI PERSONA -->
        <div id="tab-person-analysis" class="tab-content">
            <div class="card">
                <h2>üìä Analisi per Persona</h2>
                
                <div class="form-group">
                    <label>üë§ Operaio</label>
                    <select id="person-select" class="form-select">
                        <option value="">Caricamento...</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>üìÖ Periodo</label>
                    <select id="person-period" class="form-select">
                        <option value="7">Ultimi 7 giorni</option>
                        <option value="30" selected>Ultimi 30 giorni</option>
                        <option value="90">Ultimi 90 giorni</option>
                        <option value="year">Anno corrente</option>
                        <option value="custom">Personalizzato</option>
                    </select>
                </div>

                <div id="person-custom-dates" style="display: none;">
                    <div class="form-group">
                        <label>Data Inizio</label>
                        <input type="date" id="person-start-date" class="form-input">
                    </div>
                    <div class="form-group">
                        <label>Data Fine</label>
                        <input type="date" id="person-end-date" class="form-input">
                    </div>
                </div>

                <button class="btn btn-primary" onclick="loadPersonAnalysis()">üìä Carica Analisi</button>
                <button class="btn btn-secondary" onclick="exportPersonToExcel()">üì• Export Excel</button>

                <div id="person-stats" style="display: none;" class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="person-total-hours">0</div>
                        <div class="stat-label">Ore Totali</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="person-avg-hours">0</div>
                        <div class="stat-label">Media Giornaliera</div>
                    </div>
                </div>

                <div class="chart-container">
                    <canvas id="person-trend-chart"></canvas>
                </div>

                <div class="chart-container" style="height: 400px;">
                    <canvas id="person-pie-chart"></canvas>
                </div>

                <div id="person-table-container"></div>
            </div>
        </div>

        <!-- TAB: ANALISI ATTIVIT√Ä -->
        <div id="tab-activity-analysis" class="tab-content">
            <div class="card">
                <h2>üîß Analisi per Attivit√†</h2>
                
                <div class="form-group">
                    <label>üîß Attivit√†</label>
                    <select id="activity-select" class="form-select">
                        <option value="">Caricamento...</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>üìÖ Periodo</label>
                    <select id="activity-period" class="form-select">
                        <option value="7">Ultimi 7 giorni</option>
                        <option value="30" selected>Ultimi 30 giorni</option>
                        <option value="90">Ultimi 90 giorni</option>
                        <option value="year">Anno corrente</option>
                        <option value="custom">Personalizzato</option>
                    </select>
                </div>

                <div id="activity-custom-dates" style="display: none;">
                    <div class="form-group">
                        <label>Data Inizio</label>
                        <input type="date" id="activity-start-date" class="form-input">
                    </div>
                    <div class="form-group">
                        <label>Data Fine</label>
                        <input type="date" id="activity-end-date" class="form-input">
                    </div>
                </div>

                <button class="btn btn-primary" onclick="loadActivityAnalysis()">üìä Carica Analisi</button>
                <button class="btn btn-secondary" onclick="exportActivityToExcel()">üì• Export Excel</button>

                <div id="activity-stats" style="display: none;" class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="activity-total-hours">0</div>
                        <div class="stat-label">Ore Totali</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="activity-workers">0</div>
                        <div class="stat-label">Operai Coinvolti</div>
                    </div>
                </div>

                <div class="chart-container">
                    <canvas id="activity-trend-chart"></canvas>
                </div>

                <div class="chart-container" style="height: 400px;">
                    <canvas id="activity-pie-chart"></canvas>
                </div>

                <div id="activity-table-container"></div>
            </div>
        </div>

        <!-- TAB: ASSENZE -->
        <div id="tab-absences" class="tab-content">
            <div class="card">
                <h2>‚ö†Ô∏è Operai Senza Ore Oggi</h2>
                <div id="missing-today-container">
                    <div class="message message-info">Caricamento...</div>
                </div>
            </div>

            <div class="card">
                <h2>üìù Richieste Assenze in Sospeso</h2>
                <div id="pending-requests-container">
                    <div class="message message-info">Caricamento...</div>
                </div>
            </div>

            <div class="card">
                <h2>üìÖ Tutte le Assenze</h2>
                <div class="form-group">
                    <label>Filtra per periodo</label>
                    <select id="absences-filter" class="form-select" onchange="loadAllAbsences()">
                        <option value="30">Ultimi 30 giorni</option>
                        <option value="90">Ultimi 90 giorni</option>
                        <option value="all">Tutte</option>
                    </select>
                </div>
                <div id="all-absences-container"></div>
            </div>
        </div>

        <!-- TAB: OPERAI -->
        <div id="tab-workers" class="tab-content">
            <div class="card">
                <h2>üë∑ Gestione Operai</h2>
                <button class="btn btn-primary" onclick="openNewWorkerModal()">‚ûï Nuovo Operaio</button>
                <div id="workers-list"></div>
            </div>
        </div>

        <!-- TAB: ATTIVIT√Ä -->
        <div id="tab-activities" class="tab-content">
            <div class="card">
                <h2>‚öôÔ∏è Gestione Attivit√†</h2>
                <button class="btn btn-primary" onclick="openNewActivityModal()">‚ûï Nuova Attivit√†</button>
                <div id="activities-list"></div>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // CONFIGURAZIONE
        // ==========================================
        const SUPABASE_URL = 'https://xxzyhzalfqyqseedsuub.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh4enloemFsZnF5cXNlZWRzdXViIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc2ODgxNjMsImV4cCI6MjA4MzI2NDE2M30.7o18J8g0tcWX2qyrQl-zGBU10AerbHlG-R_WMkjRn7s';

        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let personTrendChart = null;
        let personPieChart = null;
        let activityTrendChart = null;
        let activityPieChart = null;

        // ==========================================
        // INIZIALIZZAZIONE
        // ==========================================
        document.addEventListener('DOMContentLoaded', async function() {
            await loadDashboardStats();
            await loadOperaiList();
            await loadAttivitaList();
            await checkMissingToday();
            await loadPendingRequests();

            // Listener per periodo custom
            document.getElementById('person-period').addEventListener('change', function() {
                document.getElementById('person-custom-dates').style.display = 
                    this.value === 'custom' ? 'block' : 'none';
            });

            document.getElementById('activity-period').addEventListener('change', function() {
                document.getElementById('activity-custom-dates').style.display = 
                    this.value === 'custom' ? 'block' : 'none';
            });
        });

        // ==========================================
        // TABS
        // ==========================================
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));

            event.target.classList.add('active');
            document.getElementById(`tab-${tabName}`).classList.add('active');

            // Carica dati specifici tab
            if (tabName === 'absences') {
                checkMissingToday();
                loadPendingRequests();
                loadAllAbsences();
            }
        }

        // ==========================================
        // DASHBOARD
        // ==========================================
        async function loadDashboardStats() {
            const today = new Date().toISOString().split('T')[0];
            const monthStart = new Date();
            monthStart.setDate(1);

            // Ore oggi
            const { data: todayData } = await supabaseClient
                .from('ore_lavorate')
                .select('ore')
                .eq('data', today);

            const todayHours = todayData ? todayData.reduce((sum, item) => sum + parseFloat(item.ore), 0) : 0;
            document.getElementById('stat-today').textContent = `${todayHours.toFixed(1)}h`;

            // Ore mese
            const { data: monthData } = await supabaseClient
                .from('ore_lavorate')
                .select('ore')
                .gte('data', monthStart.toISOString().split('T')[0]);

            const monthHours = monthData ? monthData.reduce((sum, item) => sum + parseFloat(item.ore), 0) : 0;
            document.getElementById('stat-total-hours').textContent = monthHours.toFixed(0);

            // Operai attivi
            const { data: workers } = await supabaseClient
                .from('operai')
                .select('id')
                .eq('attivo', true);

            document.getElementById('stat-active-workers').textContent = workers ? workers.length : 0;

            // Attivit√†
            const { data: activities } = await supabaseClient
                .from('attivita')
                .select('id')
                .eq('attiva', true);

            document.getElementById('stat-activities').textContent = activities ? activities.length : 0;
        }

        // ==========================================
        // ANALISI PERSONA
        // ==========================================
        async function loadOperaiList() {
            const { data, error } = await supabaseClient
                .from('operai')
                .select('*')
                .eq('attivo', true)
                .order('nome');

            if (!error && data) {
                const select = document.getElementById('person-select');
                select.innerHTML = '<option value="">Seleziona operaio...</option>';
                data.forEach(op => {
                    select.innerHTML += `<option value="${op.id}">${op.nome} ${op.cognome}</option>`;
                });
            }
        }

        async function loadAttivitaList() {
            const { data, error } = await supabaseClient
                .from('attivita')
                .select('*')
                .eq('attiva', true)
                .order('ordine');

            if (!error && data) {
                const select = document.getElementById('activity-select');
                select.innerHTML = '<option value="">Seleziona attivit√†...</option>';
                data.forEach(att => {
                    select.innerHTML += `<option value="${att.id}">${att.icona} ${att.nome}</option>`;
                });
            }
        }

        async function loadPersonAnalysis() {
            const operaioId = document.getElementById('person-select').value;
            const period = document.getElementById('person-period').value;

            if (!operaioId) {
                showMessage('Seleziona un operaio', 'error');
                return;
            }

            const { startDate, endDate } = calculateDateRange(period, 'person');

            const { data, error } = await supabaseClient
                .from('ore_lavorate')
                .select('*, attivita(nome, icona)')
                .eq('operaio_id', operaioId)
                .gte('data', startDate)
                .lte('data', endDate)
                .order('data');

            if (error) {
                console.error('Errore:', error);
                showMessage('Errore nel caricamento dati', 'error');
                return;
            }

            if (!data || data.length === 0) {
                showMessage('Nessun dato trovato per il periodo selezionato', 'info');
                return;
            }

            // Mostra statistiche
            document.getElementById('person-stats').style.display = 'grid';
            const totalHours = data.reduce((sum, item) => sum + parseFloat(item.ore), 0);
            const daysCount = new Set(data.map(item => item.data)).size;
            const avgHours = totalHours / daysCount;

            document.getElementById('person-total-hours').textContent = totalHours.toFixed(1);
            document.getElementById('person-avg-hours').textContent = avgHours.toFixed(1);

            // Processa dati per grafici
            const dailyData = {};
            const activityData = {};

            data.forEach(item => {
                // Trend giornaliero
                if (!dailyData[item.data]) {
                    dailyData[item.data] = 0;
                }
                dailyData[item.data] += parseFloat(item.ore);

                // Distribuzione attivit√†
                const actName = item.attivita.nome;
                if (!activityData[actName]) {
                    activityData[actName] = 0;
                }
                activityData[actName] += parseFloat(item.ore);
            });

            updatePersonTrendChart(dailyData);
            updatePersonPieChart(activityData);
            updatePersonTable(data);

            showMessage('‚úÖ Analisi caricata con successo!', 'success');
        }

        function updatePersonTrendChart(dailyData) {
            const ctx = document.getElementById('person-trend-chart').getContext('2d');

            if (personTrendChart) {
                personTrendChart.destroy();
            }

            personTrendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: Object.keys(dailyData),
                    datasets: [{
                        label: 'Ore Giornaliere',
                        data: Object.values(dailyData),
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4,
                        fill: true,
                        pointBackgroundColor: '#3b82f6',
                        pointRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: '#fff', font: { size: 14 } }
                        },
                        title: {
                            display: true,
                            text: 'Trend Ore nel Tempo',
                            color: '#60a5fa',
                            font: { size: 16 }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { color: '#94a3b8' },
                            grid: { color: 'rgba(148, 163, 184, 0.1)' }
                        },
                        x: {
                            ticks: { color: '#94a3b8', maxRotation: 45 },
                            grid: { color: 'rgba(148, 163, 184, 0.1)' }
                        }
                    }
                }
            });
        }

        function updatePersonPieChart(activityData) {
            const ctx = document.getElementById('person-pie-chart').getContext('2d');

            if (personPieChart) {
                personPieChart.destroy();
            }

            const colors = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#14b8a6', '#f97316'];

            personPieChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(activityData),
                    datasets: [{
                        data: Object.values(activityData),
                        backgroundColor: colors,
                        borderWidth: 3,
                        borderColor: '#1e293b'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { 
                                color: '#fff', 
                                padding: 15,
                                font: { size: 13 }
                            }
                        },
                        title: {
                            display: true,
                            text: 'Distribuzione Ore per Attivit√† (%)',
                            color: '#60a5fa',
                            font: { size: 16 }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${label}: ${value}h (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function updatePersonTable(data) {
            const container = document.getElementById('person-table-container');
            
            let html = '<h3 style="color: #60a5fa; margin-top: 30px;">üìã Dettaglio Ore</h3>';
            html += '<table><thead><tr><th>Data</th><th>Attivit√†</th><th>Ore</th><th>Note</th></tr></thead><tbody>';

            data.forEach(item => {
                html += `<tr>
                    <td>${item.data}</td>
                    <td>${item.attivita.icona} ${item.attivita.nome}</td>
                    <td><strong>${item.ore}h</strong></td>
                    <td>${item.note || '-'}</td>
                </tr>`;
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        async function exportPersonToExcel() {
            const operaioId = document.getElementById('person-select').value;
            const period = document.getElementById('person-period').value;

            if (!operaioId) {
                showMessage('Seleziona un operaio', 'error');
                return;
            }

            const { startDate, endDate } = calculateDateRange(period, 'person');

            const { data: oreData } = await supabaseClient
                .from('ore_lavorate')
                .select('*, operai(nome, cognome), attivita(nome)')
                .eq('operaio_id', operaioId)
                .gte('data', startDate)
                .lte('data', endDate)
                .order('data');

            if (!oreData || oreData.length === 0) {
                showMessage('Nessun dato da esportare', 'error');
                return;
            }

            const wb = XLSX.utils.book_new();
            
            const operaioName = `${oreData[0].operai.nome} ${oreData[0].operai.cognome}`.trim();

            // Prepara dati
            const sheetData = [
                ['ANALISI ORE OPERAIO'],
                [`Operaio: ${operaioName}`],
                [`Periodo: ${startDate} a ${endDate}`],
                [],
                ['Data', 'Attivit√†', 'Ore', 'Note']
            ];

            oreData.forEach(item => {
                sheetData.push([
                    item.data,
                    item.attivita.nome,
                    item.ore,
                    item.note || ''
                ]);
            });

            // Statistiche
            const totalOre = oreData.reduce((sum, item) => sum + parseFloat(item.ore), 0);
            const activityStats = {};
            oreData.forEach(item => {
                if (!activityStats[item.attivita.nome]) {
                    activityStats[item.attivita.nome] = 0;
                }
                activityStats[item.attivita.nome] += parseFloat(item.ore);
            });

            sheetData.push([]);
            sheetData.push(['TOTALE ORE', '', totalOre.toFixed(1), '']);
            sheetData.push([]);
            sheetData.push(['DISTRIBUZIONE ATTIVIT√Ä']);
            
            Object.entries(activityStats).forEach(([nome, ore]) => {
                const perc = ((ore / totalOre) * 100).toFixed(1);
                sheetData.push([nome, ore.toFixed(1), `${perc}%`]);
            });

            const ws = XLSX.utils.aoa_to_sheet(sheetData);
            XLSX.utils.book_append_sheet(wb, ws, 'Analisi Operaio');

            XLSX.writeFile(wb, `Analisi_${operaioName}_${startDate}_${endDate}.xlsx`);
            showMessage('‚úÖ Excel esportato con successo!', 'success');
        }

        // ==========================================
        // ANALISI ATTIVIT√Ä
        // ==========================================
        async function loadActivityAnalysis() {
            const attivitaId = document.getElementById('activity-select').value;
            const period = document.getElementById('activity-period').value;

            if (!attivitaId) {
                showMessage('Seleziona un\'attivit√†', 'error');
                return;
            }

            const { startDate, endDate } = calculateDateRange(period, 'activity');

            const { data, error } = await supabaseClient
                .from('ore_lavorate')
                .select('*, operai(nome, cognome)')
                .eq('attivita_id', attivitaId)
                .gte('data', startDate)
                .lte('data', endDate)
                .order('data');

            if (error) {
                console.error('Errore:', error);
                showMessage('Errore nel caricamento dati', 'error');
                return;
            }

            if (!data || data.length === 0) {
                showMessage('Nessun dato trovato per il periodo selezionato', 'info');
                return;
            }

            // Statistiche
            document.getElementById('activity-stats').style.display = 'grid';
            const totalHours = data.reduce((sum, item) => sum + parseFloat(item.ore), 0);
            const uniqueWorkers = new Set(data.map(item => item.operaio_id)).size;

            document.getElementById('activity-total-hours').textContent = totalHours.toFixed(1);
            document.getElementById('activity-workers').textContent = uniqueWorkers;

            // Processa dati
            const dailyData = {};
            const workerData = {};

            data.forEach(item => {
                // Trend giornaliero
                if (!dailyData[item.data]) {
                    dailyData[item.data] = 0;
                }
                dailyData[item.data] += parseFloat(item.ore);

                // Distribuzione operai
                const workerName = `${item.operai.nome} ${item.operai.cognome}`.trim();
                if (!workerData[workerName]) {
                    workerData[workerName] = 0;
                }
                workerData[workerName] += parseFloat(item.ore);
            });

            updateActivityTrendChart(dailyData);
            updateActivityPieChart(workerData);
            updateActivityTable(data);

            showMessage('‚úÖ Analisi caricata con successo!', 'success');
        }

        function updateActivityTrendChart(dailyData) {
            const ctx = document.getElementById('activity-trend-chart').getContext('2d');

            if (activityTrendChart) {
                activityTrendChart.destroy();
            }

            activityTrendChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(dailyData),
                    datasets: [{
                        label: 'Ore Totali Giornaliere',
                        data: Object.values(dailyData),
                        backgroundColor: 'rgba(16, 185, 129, 0.6)',
                        borderColor: '#10b981',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: '#fff', font: { size: 14 } }
                        },
                        title: {
                            display: true,
                            text: 'Trend Ore Attivit√† nel Tempo',
                            color: '#60a5fa',
                            font: { size: 16 }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { color: '#94a3b8' },
                            grid: { color: 'rgba(148, 163, 184, 0.1)' }
                        },
                        x: {
                            ticks: { color: '#94a3b8', maxRotation: 45 },
                            grid: { color: 'rgba(148, 163, 184, 0.1)' }
                        }
                    }
                }
            });
        }

        function updateActivityPieChart(workerData) {
            const ctx = document.getElementById('activity-pie-chart').getContext('2d');

            if (activityPieChart) {
                activityPieChart.destroy();
            }

            const colors = ['#10b981', '#3b82f6', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#14b8a6', '#f97316'];

            activityPieChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(workerData),
                    datasets: [{
                        data: Object.values(workerData),
                        backgroundColor: colors,
                        borderWidth: 3,
                        borderColor: '#1e293b'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { 
                                color: '#fff', 
                                padding: 15,
                                font: { size: 13 }
                            }
                        },
                        title: {
                            display: true,
                            text: 'Distribuzione Ore per Operaio (%)',
                            color: '#60a5fa',
                            font: { size: 16 }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${label}: ${value}h (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateActivityTable(data) {
            const container = document.getElementById('activity-table-container');
            
            let html = '<h3 style="color: #60a5fa; margin-top: 30px;">üìã Dettaglio Ore</h3>';
            html += '<table><thead><tr><th>Data</th><th>Operaio</th><th>Ore</th><th>Note</th></tr></thead><tbody>';

            data.forEach(item => {
                const workerName = `${item.operai.nome} ${item.operai.cognome}`.trim();
                html += `<tr>
                    <td>${item.data}</td>
                    <td>${workerName}</td>
                    <td><strong>${item.ore}h</strong></td>
                    <td>${item.note || '-'}</td>
                </tr>`;
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        async function exportActivityToExcel() {
            const attivitaId = document.getElementById('activity-select').value;
            const period = document.getElementById('activity-period').value;

            if (!attivitaId) {
                showMessage('Seleziona un\'attivit√†', 'error');
                return;
            }

            const { startDate, endDate } = calculateDateRange(period, 'activity');

            const { data: oreData } = await supabaseClient
                .from('ore_lavorate')
                .select('*, operai(nome, cognome), attivita(nome)')
                .eq('attivita_id', attivitaId)
                .gte('data', startDate)
                .lte('data', endDate)
                .order('data');

            if (!oreData || oreData.length === 0) {
                showMessage('Nessun dato da esportare', 'error');
                return;
            }

            const wb = XLSX.utils.book_new();
            
            const attivitaName = oreData[0].attivita.nome;

            const sheetData = [
                ['ANALISI ORE ATTIVIT√Ä'],
                [`Attivit√†: ${attivitaName}`],
                [`Periodo: ${startDate} a ${endDate}`],
                [],
                ['Data', 'Operaio', 'Ore', 'Note']
            ];

            oreData.forEach(item => {
                const workerName = `${item.operai.nome} ${item.operai.cognome}`.trim();
                sheetData.push([
                    item.data,
                    workerName,
                    item.ore,
                    item.note || ''
                ]);
            });

            const totalOre = oreData.reduce((sum, item) => sum + parseFloat(item.ore), 0);
            const workerStats = {};
            oreData.forEach(item => {
                const workerName = `${item.operai.nome} ${item.operai.cognome}`.trim();
                if (!workerStats[workerName]) {
                    workerStats[workerName] = 0;
                }
                workerStats[workerName] += parseFloat(item.ore);
            });

            sheetData.push([]);
            sheetData.push(['TOTALE ORE', '', totalOre.toFixed(1), '']);
            sheetData.push([]);
            sheetData.push(['DISTRIBUZIONE OPERAI']);
            
            Object.entries(workerStats).forEach(([nome, ore]) => {
                const perc = ((ore / totalOre) * 100).toFixed(1);
                sheetData.push([nome, ore.toFixed(1), `${perc}%`]);
            });

            const ws = XLSX.utils.aoa_to_sheet(sheetData);
            XLSX.utils.book_append_sheet(wb, ws, 'Analisi Attivit√†');

            XLSX.writeFile(wb, `Analisi_${attivitaName}_${startDate}_${endDate}.xlsx`);
            showMessage('‚úÖ Excel esportato con successo!', 'success');
        }

        // ==========================================
        // ASSENZE
        // ==========================================
        async function checkMissingToday() {
            const today = new Date().toISOString().split('T')[0];

            const { data: operai } = await supabaseClient
                .from('operai')
                .select('id, nome, cognome')
                .eq('attivo', true);

            const { data: oreOggi } = await supabaseClient
                .from('ore_lavorate')
                .select('operaio_id')
                .eq('data', today);

            const registratiIds = new Set((oreOggi || []).map(o => o.operaio_id));

            const { data: assenzeOggi } = await supabaseClient
                .from('assenze')
                .select('operaio_id, tipo')
                .lte('data_inizio', today)
                .gte('data_fine', today)
                .eq('approvata', true);

            const assentiMap = {};
            (assenzeOggi || []).forEach(a => {
                assentiMap[a.operaio_id] = a.tipo;
            });

            const container = document.getElementById('missing-today-container');
            let html = '';

            operai.forEach(op => {
                if (!registratiIds.has(op.id)) {
                    const tipo = assentiMap[op.id];
                    if (tipo) {
                        const icon = tipo === 'ferie' ? 'üèñÔ∏è' : tipo === 'malattia' ? 'üè•' : 'üìù';
                        html += `<div class="absent-item justified">
                            ${icon} <strong>${op.nome} ${op.cognome}</strong> - ${tipo.toUpperCase()} ‚úÖ
                        </div>`;
                    } else {
                        html += `<div class="absent-item">
                            ‚ùå <strong>${op.nome} ${op.cognome}</strong> - Nessuna ora registrata
                        </div>`;
                    }
                }
            });

            if (!html) {
                html = '<div class="message message-success">‚úÖ Tutti gli operai hanno registrato ore oggi!</div>';
            }

            container.innerHTML = html;
        }

        async function loadPendingRequests() {
            const { data, error } = await supabaseClient
                .from('assenze')
                .select('*, operai(nome, cognome)')
                .eq('approvata', false)
                .order('created_at', { ascending: false });

            const container = document.getElementById('pending-requests-container');
            
            if (!data || data.length === 0) {
                container.innerHTML = '<div class="message message-info">Nessuna richiesta in sospeso</div>';
                return;
            }

            let html = '';
            data.forEach(req => {
                const workerName = `${req.operai.nome} ${req.operai.cognome}`.trim();
                html += `<div class="request-item">
                    <div>
                        <strong>${workerName}</strong><br>
                        Tipo: ${req.tipo} | Dal ${req.data_inizio} al ${req.data_fine}<br>
                        ${req.motivo ? `Motivo: ${req.motivo}` : ''}
                    </div>
                    <div>
                        <button class="btn btn-primary" onclick="approveRequest('${req.id}')">‚úÖ Approva</button>
                        <button class="btn btn-secondary" onclick="rejectRequest('${req.id}')">‚ùå Rifiuta</button>
                    </div>
                </div>`;
            });

            container.innerHTML = html;
        }

        async function approveRequest(id) {
            const { error } = await supabaseClient
                .from('assenze')
                .update({ approvata: true })
                .eq('id', id);

            if (!error) {
                showMessage('‚úÖ Richiesta approvata!', 'success');
                loadPendingRequests();
                checkMissingToday();
            }
        }

        async function rejectRequest(id) {
            const { error } = await supabaseClient
                .from('assenze')
                .delete()
                .eq('id', id);

            if (!error) {
                showMessage('‚ùå Richiesta rifiutata', 'info');
                loadPendingRequests();
            }
        }

        async function loadAllAbsences() {
            const filter = document.getElementById('absences-filter').value;
            let query = supabaseClient
                .from('assenze')
                .select('*, operai(nome, cognome)')
                .eq('approvata', true)
                .order('data_inizio', { ascending: false });

            if (filter !== 'all') {
                const daysAgo = new Date();
                daysAgo.setDate(daysAgo.getDate() - parseInt(filter));
                query = query.gte('data_inizio', daysAgo.toISOString().split('T')[0]);
            }

            const { data } = await query;

            const container = document.getElementById('all-absences-container');
            
            if (!data || data.length === 0) {
                container.innerHTML = '<div class="message message-info">Nessuna assenza trovata</div>';
                return;
            }

            let html = '<table><thead><tr><th>Operaio</th><th>Tipo</th><th>Dal</th><th>Al</th><th>Motivo</th></tr></thead><tbody>';
            
            data.forEach(abs => {
                const workerName = `${abs.operai.nome} ${abs.operai.cognome}`.trim();
                html += `<tr>
                    <td>${workerName}</td>
                    <td>${abs.tipo}</td>
                    <td>${abs.data_inizio}</td>
                    <td>${abs.data_fine}</td>
                    <td>${abs.motivo || '-'}</td>
                </tr>`;
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        // ==========================================
        // UTILITY
        // ==========================================
        function calculateDateRange(period, type) {
            const today = new Date();
            let startDate, endDate;

            if (period === 'custom') {
                const startInput = type === 'person' ? 'person-start-date' : 'activity-start-date';
                const endInput = type === 'person' ? 'person-end-date' : 'activity-end-date';
                
                startDate = new Date(document.getElementById(startInput).value);
                endDate = new Date(document.getElementById(endInput).value);
            } else {
                endDate = today;
                startDate = new Date(today);
                
                switch(period) {
                    case '7':
                        startDate.setDate(startDate.getDate() - 7);
                        break;
                    case '30':
                        startDate.setDate(startDate.getDate() - 30);
                        break;
                    case '90':
                        startDate.setDate(startDate.getDate() - 90);
                        break;
                    case 'year':
                        startDate = new Date(today.getFullYear(), 0, 1);
                        break;
                }
            }

            return {
                startDate: startDate.toISOString().split('T')[0],
                endDate: endDate.toISOString().split('T')[0]
            };
        }

        function showMessage(message, type) {
            const container = document.getElementById('status-message');
            container.innerHTML = `<div class="message message-${type}">${message}</div>`;
            setTimeout(() => container.innerHTML = '', 4000);
        }

        // Placeholder functions (gi√† esistenti)
        function openNewWorkerModal() {
            alert('Funzionalit√† da implementare - Usa il gestionale esistente');
        }

        function openNewActivityModal() {
            alert('Funzionalit√† da implementare - Usa il gestionale esistente');
        }
    </script>
</body>
</html>
